### Мотивация  

#### Почему нужен трейсинг?  
Сейчас заказы могут:  
- Зависать в неизвестном статусе (непонятно, где произошел сбой).  
- Теряться между сервисами (особенно в RabbitMQ).  
- Обрабатываться слишком долго (непонятно, какой сервис затормаживает процесс).  

Что даёт трейсинг бизнесу и разработчикам?  
* Возможность отслеживать путь заказа через все сервисы.  
* Быстро находить узкие места и оптимизировать работу системы.  
* Снижает время на разбор инцидентов и устранение багов.  

#### Какие метрики улучшит трейсинг?  
* Время обработки заказов (сократится за счёт оптимизации узких мест).  
* Доля потерянных заказов (можно будет оперативно находить проблемы).  
* Количество заказов в подвисшем статусе (можно будет быстрее реагировать).  

---

### Предлагаемое решение  

#### Какие системы покрываем трейсингом?  
Выделяем ключевые места, где заказ может «сломаться»:  

1. API Интернет-магазина – Отслеживаем путь заказа от создания до оплаты.  
2. CRM – Проверяем, где заказы могут «застрять» в подтверждении.  
3. MES – Отслеживаем движение заказа через производство.  
4. RabbitMQ – Анализируем потерю или зависание сообщений.  
5. Базы данных (Shop, MES) – Следим за медленными запросами.  

#### Метрики для трейсинга  
* ID заказа – Позволяет отслеживать конкретный заказ.  
* Время обработки запроса в каждом сервисе.  
* Ошибки на каждом этапе – фиксируем код ошибки и сообщение.  
* События в RabbitMQ – записываем факт публикации и обработки.  
* SQL-запросы к БД – следим за медленными запросами.  

---

### Имлпементация  

Используем OpenTelemetry + Jaeger:  
- OpenTelemetry SDK добавляем в Shop API, CRM, MES.  
- OpenTelemetry Collector собирает данные и отправляет в Jaeger.  
- Jaeger используется для визуализации трассировок.  

#### Новые компоненты (выделены красным на диаграмме)  
* OpenTelemetry SDK – встраивается в API и сервисы.  
* OpenTelemetry Collector – агрегирует данные.  
* Jaeger UI – инструмент для анализа трассировок.  

[Обновлённая диаграмма](jewerly_c4_model.png)

---

### Недостатки  

* Не поможет, если сбой вне нашей системы (например, сбой в стороннем API доставки).  
* Трудозатраты на внедрение (нужно встраивать SDK в код).  
* Дополнительные ресурсы (Jaeger требует место для хранения логов).  

---

### Безопасность  

* Трейсы только внутри компании (запрещаем внешний доступ к Jaeger).  
* Доступ к Jaeger – только через VPN или SSO-аутентификацию.  
* Фильтрация данных – исключаем персональные данные клиентов.  

---

### Результат через 3 месяца  
* Можно в реальном времени видеть путь заказа и понимать, где сбои.  
* Сократится время на разбор инцидентов.  
* Разработчики быстрее находят узкие места и оптимизируют систему.  
