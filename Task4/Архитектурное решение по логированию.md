### Мотивация  

Сейчас разработчики и поддержка вынуждены разбирать проблемы на основании слов клиентов. Это приводит к следующим проблемам:  

- Длительное время расследования инцидентов.  
- Отсутствие полной картины произошедшего.  
- Увеличенная нагрузка на техническую поддержку.  

Внедрение системного логирования позволит:  

- Сократить время поиска и устранения ошибок.  
- Автоматизировать выявление проблем и аномалий.  
- Повысить качество обслуживания клиентов.  

### Ключевые метрики, на которые повлияет логирование  

1. Среднее время расследования инцидентов – должно сократиться за счет централизованного хранения логов.  
2. Число повторяющихся обращений в поддержку – уменьшится, так как разработчики смогут оперативно находить и устранять причины проблем.  
3. Процент заказов, застрявших в процессе обработки – снизится за счет быстрого выявления проблемных точек.  

### Какие логи нужно собирать и из каких систем  

#### Уровни логирования  

- `INFO` – логирование бизнес-операций (например, изменение статуса заказа, успешная обработка запроса).  
- `WARNING` – логирование аномальных, но не критичных ситуаций (например, превышено время ответа API, заказ завис в неопределенном состоянии).  
- `ERROR` – критические ошибки, приводящие к отказу в обработке (например, сбой базы данных, падение сервиса).  
- `DEBUG` – используется только в dev-окружении и при отладке сложных проблем.  

#### Перечень логов (уровень INFO)  

| Сервис                      | Событие                  | Поля                                                             |
| --------------------------- | ------------------------ | ---------------------------------------------------------------- |
| Интернет-магазин (Shop API) | Создание заказа          | Время, ID заказа, ID клиента, список товаров                     |
| Интернет-магазин (Shop API) | Изменение статуса заказа | Время, ID заказа, старый статус, новый статус                    |
| CRM                         | Подтверждение заказа     | Время, ID заказа, ID менеджера                                   |
| CRM                         | Закрытие заказа          | Время, ID заказа, причина закрытия                               |
| MES                         | Начало производства      | Время, ID заказа, ID оператора                                   |
| MES                         | Завершение производства  | Время, ID заказа, ID оператора                                   |
| RabbitMQ                    | Публикация события       | Время, ID заказа, тип события                                    |
| RabbitMQ                    | Доставка сообщения       | Время, ID заказа, статус доставки                                |
| База данных (Shop, MES)     | Запрос к БД              | Время, тип запроса, ID заказа (если применимо), время выполнения |

### Приоритет внедрения логирования и трейсинга  

Так как невозможно сразу реализовать все элементы, внедрение будет поэтапным:  

1. Критические бизнес-процессы (логирование и трейсинг):  
   - API интернет-магазина (Shop API) – позволяет понять, на каком этапе теряются заказы.  
   - CRM – критично для контроля за подтверждением и закрытием заказов.  
   - MES – отслеживание производства и упаковки.  

2. Критические технические компоненты (логирование):  
   - RabbitMQ – контроль за доставкой сообщений, выявление потерь.  
   - Базы данных (Shop, MES) – отслеживание медленных запросов.  

### Предлагаемое решение  

#### Выбор технологий  

- Логирование – ELK (Elasticsearch, Logstash, Kibana) или Grafana Loki.  
- Централизованный сбор логов – Fluentd или Filebeat.  
- Хранение логов – Yandex Managed Elasticsearch.  
- Аналитика и визуализация – Kibana или Grafana.  

#### Как будет реализовано  

1. Внедрение Fluentd/Filebeat на сервисах (Shop API, CRM, MES).  
2. Настройка сбора логов из RabbitMQ и баз данных.  
3. Развертывание Elasticsearch для хранения логов.  
4. Визуализация логов в Kibana/Grafana.  
5. Настройка алертинга в Grafana или Prometheus Alertmanager.  

## Политика безопасности  

- Доступ к логам только для авторизованных сотрудников (DevOps, backend-разработчики, поддержка).  
- Исключение из логов персональных данных клиентов (ФИО, контактные данные).  
- Логирование запросов пользователей без хранения паролей и других чувствительных данных.  

## Политика хранения  

- Разделение логов по индексам (например, `shop-api-logs`, `crm-logs`).  
- Хранение логов за последние 90 дней.  
- Архивирование старых логов в S3.  

## Дополнительные мероприятия  

- Настройка алертов – уведомления о росте ошибок 500, превышении времени ответа API.  
- Выявление аномалий – анализ резкого увеличения заказов (возможный DDoS).  
- Фильтрация логов – исключение повторяющихся сообщений для уменьшения нагрузки.  

## Результаты через 3 месяца  

- Разработчики смогут быстро находить причины ошибок.  
- Сократится количество обращений в поддержку.  
- Будет обеспечен контроль за всеми ключевыми бизнес-процессами.  
