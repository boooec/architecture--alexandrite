Вот план по внедрению мониторинга для системы «Александрит»:  

---

### Мотивация  

Почему мониторинг важен?  
На данный момент система работает в продакшене, но команда сталкивается с:  
- Медленной загрузкой MES без четкого понимания узких мест.  
- Долгим расчетом стоимости заказов, что замедляет обработку.  
- Проблемами с RabbitMQ, приводящими к задержкам обработки заказов.  
- Долгими релизами из-за отсутствия данных о влиянии изменений.  

Что даёт мониторинг?  
- Повышение стабильности: быстрая реакция на сбои.  
- Оптимизация затрат: выявление узких мест и оптимизация ресурсов.  
- Ускорение разработки: объективные данные помогут избежать догадок при поиске проблем.  

---

### Выбор подхода к мониторингу  

Используем «Четыре золотых сигнала» для API и RabbitMQ.  
Дополнительно применяем USE для инфраструктуры (CPU, память, БД).  

- API (Shop, CRM, MES) – «Четыре золотых сигнала»  
- RabbitMQ – «Четыре золотых сигнала»  
- БД и серверы – USE  

---

### Метрики и их обоснование  

#### 1. Нагрузка на API (Shop, CRM, MES)  
RPS (Number of requests)  
- Зачем? Позволяет отследить аномальное поведение (резкий рост/падение трафика).  
- Ярлыки: `service`, `user_id` (чтобы выявить ботов или проблемных пользователей).  

Response time (latency)  
- Зачем? Замеряем среднюю и 95-й перцентиль задержки. Позволит найти медленные эндпоинты.  
- Ярлыки: `service`, `endpoint`.  

Количество HTTP 500 (ошибки сервера)  
- Зачем? Позволяет оперативно находить критические ошибки.  
- Ярлыки: `service`, `endpoint`.  

Количество активных сессий (simultaneous sessions)  
- Зачем? Помогает оценить нагрузку в пиковые часы.  

CPU % и Memory Utilisation для API  
- Зачем? Чтобы понимать, когда сервису не хватает ресурсов.  

---

#### 2. RabbitMQ (очереди заказов и событий)  
Number of dead-letter-exchange letters  
- Зачем? Если сообщений в dead-letter много, значит, есть проблема с обработкой заказов.  
- Ярлыки: `queue_name`.  

Number of messages in flight  
- Зачем? Показывает, есть ли заторы в очередях.  

---

#### 3. Базы данных (Shop, MES)  
Number of connections  
- Зачем? Помогает выявить утечки соединений.  

Memory Utilisation  
- Зачем? Чтобы не было ситуации, когда БД начинает тормозить из-за нехватки памяти.  

Размер БД  
- Зачем? Для оценки будущего масштабирования.  

---

#### 4. Файловое хранилище (S3)  
Размер хранилища  
- Зачем? Контроль расходов на хранение данных.  

---

### План действий  

1. Настроить сбор метрик  
   - Используем Prometheus (для метрик API, RabbitMQ, БД).  
   - Используем Grafana для визуализации.  

2. Создать дашборды  
   - API: RPS, Latency, Ошибки 500, CPU/Memory.  
   - RabbitMQ: Dead-letter, Messages in flight.  
   - БД: Connections, Размер, Утилизация памяти.  

3. Настроить алерты  
   - Если Latency > 2 сек — оповещение в Slack.  
   - Если % ошибок 500 > 1% за 5 минут — алерт DevOps.  
   - Если RabbitMQ перегружен — уведомление разработчикам.  

4. Обучить команду работать с мониторингом  
   - Регулярно проверять дашборды.  
   - Реагировать на алерты.  

---

### Результат через 3 месяца  
- Проблемы в MES выявляются сразу.  
- Снижение времени простоя API.  
- Бизнес получает аналитику по заказам.  
