### Анализ существующей архитектуры: проблемы и риски  

#### Проблемы и их причины:

1. *Долгая загрузка первой страницы MES даже после введения фильтрации и пагинации.*  
   * Запросы к БД не оптимизированы, нет кеширования, слишком большой объём данных загружается сразу.  

2. *В зависимости от сложности модели расчёт может занимать до 30 минут, что влияет на скорость обработки заказов.*  
   * Отсутствие параллельной обработки сложных моделей.  
   * Отсутствие worker-узлов, которые бы разгружали основной сервис MES.  

3. *Задержки в обработке заказов, возможные потери сообщений между CRM, MES и API.*  
   * Очередь может быть перегружена или плохо масштабируется.  
   * Отсутствие приоритезации сообщений (например, API-заказы идут в той же очереди, что и заказы B2C).  

4. *Каждое приложение и база данных работают на одном инстансе. При росте нагрузки может появиться узкое место.*  
   * Отсутствие горизонтального масштабирования, нет реплик БД для распределения нагрузки.  

5. *Ручное тестирование приводит к задержкам релизов, увеличивается время вывода фич в продакшен.*  
   * Нет автоматизированного тестирования на уровне интеграции и E2E.  

---

### Список инициатив для устранения проблем  

#### Высокий приоритет (решают критические проблемы)  
1. Оптимизация работы MES API и UI  
   - Разобраться с медленной загрузкой заказов: кеширование, индексация, изменение структуры запросов.  
   - Оптимизировать механизм загрузки списка заказов из API:
     - Пагинацией. Пользователь при скроллинге заказов сможет дойти до "конца" списка, и нажать кнопку "Загрузить еще". Эта кнопка отправит дополнительный запрос на получение очередной части списка заказов. Так мы уменьшим время первого рендера страницы, так как уменьшим объём мгновенной нагрузки на API.
     - Асинхронным обращением в API. Сначала отображать юзеру заглушки (плейсхолдеры) заказов, параллельно отправляя запрос на получение небольшой части заказов в API. После загрузки части заказов – отобразить их вместо заглушек, и сразу отправить запрос API на следующий блок. Так мы уменьшим время первого рендера страницы, так как избежим синхронного похода в API.  

       Оба варианта уменьшают нагрузку на базу данных, так как загружают заказы лишь по необходимости. Также можно сократить нагрузку на кэш, сохраняя в него лишь первые списки заказов вместо всей выборки.

2. Масштабирование инфраструктуры  
   - Развернуть дополнительные инстансы для сервисов и БД (добавить реплику для PostgreSQL).  
   - Использовать auto-scaling для приложений (EC2 с балансировкой нагрузки).  

3. Оптимизация расчёта стоимости заказов в MES  
   - Вынести расчёты в отдельные worker-узлы (например, через AWS Lambda или отдельные микросервисы).  
   - Ввести механизм асинхронного уведомления о готовности расчёта.  

#### Средний приоритет (улучшает стабильность и скорость работы системы)  
4. Оптимизация RabbitMQ  
   - Разделение очередей на приоритетные (API-заказы, B2C-заказы, статусы заказов).  
   - Включение мониторинга и алертов на задержку сообщений.  

5. Внедрение автоматизированного тестирования  
   - Ввести unit и интеграционные тесты на уровне CI/CD.  
   - Разработать E2E-тесты на критичные бизнес-процессы.  

6. Улучшение мониторинга и логирования  
   - Настроить сбор метрик для RabbitMQ, API и базы данных.  
   - Внедрить централизованный логирование через ELK или аналогичные инструменты.  

#### Низкий приоритет (будет полезно в будущем, но не критично сейчас)  
7. Обновление API и документации  
   - Улучшение API-документации для сторонних пользователей.  
   - Введение версионирования API.  

8. Развитие DevOps-процессов  
   - Автоматизация деплоя в релизное окружение.  
   - Контейнеризация сервисов с возможностью разворачивания в Kubernetes.  

---

### Целевая архитектура через полгода  

Масштабируемая инфраструктура  
   - Минимум два инстанса для каждого сервиса.  
   - Реплицированная база данных для уменьшения нагрузки.  

Оптимизированный MES  
   - Ускоренная работа дашборда операторов (менее 2 секунд на загрузку).  
   - Расчёт стоимости вынесен в воркер-узлы.  

Стабильная система обмена сообщениями  
   - RabbitMQ с приоритетными очередями и мониторингом.  

Быстрые релизы с автоматизированным тестированием  
   - Внедрены unit, интеграционные и E2E-тесты.  

---

### Три инициативы на ближайшие полгода  
Если можно сделать только три вещи, выберу:  

1. Оптимизация MES API и UI (ускорение работы операторов)  
2. Масштабирование инфраструктуры (устранение узких мест)  
3. Вынесение расчёта стоимости в воркеры (ускорение обработки заказов)  

#### Почему именно они?  
- Они устраняют самые критичные проблемы (медленный MES, долгий расчёт цен, проблемы с инфраструктурой).  
- Их реализация даст видимый эффект как для клиентов, так и для операторов.  
- Они закладывают основу для будущего масштабирования системы.  
